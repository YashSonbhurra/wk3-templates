{{FrontSide}}

<!--
The Template is divided into sections.
Sections get turned off based on which Card Type is displayed.
-->

<div id=card-back>

<!--Radical Combination Section-->
<!--For: Kanji-->
<div id=section-radical-combination>
	Radical Combination<hr>
	<div id=combination></div>
</div>

<!--Meaning Section-->
<!--For: Radical, Kanji, Vocabulary-->

<div id=section-meaning>
	<div id=meaning-title></div>
	<p id=meanings></p>
	<p class="explanation">Explanation</p>
	<div class="mnemonic">{{Meaning_Mnemonic}}</div>
	<div id="meaning-hint">
		<div class="mnemonic-hint">
			<p class="hint"><img src="_hint.png" width="12" height="12">
			<b style="vertical-align: top">HINTS</b><br></p>{{Meaning_Hint}}
		</div>
	</div>
</div>

<!--Reading Section-->
<!--For: Kanji, Vocabulary-->

<div id=section-reading>
	Reading<hr>
	<div id=vocabulary-reading>{{Reading}}</div>
	<div id=kanji-readings>
		<div id=reading-container>
			<div id=onyomi-readings>On’yomi<br>{{Reading_Onyomi}}</div>
			<div id=kunyomi-readings>Kun’yomi<br>{{Reading_Kunyomi}}</div>
			<div id=nanori-readings>Nanori<br>{{Reading_Nanori}}</div>
		</div>
	</div>
	<div id="reading-audios">{{Audio}}</div>
	<p class="explanation">Explanation</p>
	<div class="mnemonic">{{Reading_Mnemonic}}</div>
	<div id="reading-hint">
		<div class="mnemonic-hint">
			<p class="hint"><img src="_hint.png" width="9" height="9">
			<b>HINTS</b><br></p>{{Reading_Hint}}
		</div>
	</div>
</div>

<!--Context Section-->
<!--For: Vocabulary-->
<div id=section-context>
	Context<hr>
	<div id="context-patterns">
		<div id="patterns-of-use">
			<p class="explanation">Patterns of Use</p>
		</div>
		<div id="common-word-combinations">
			<p class="explanation">Common Word Combinations</p>
		</div>
	</div>
	<p class="explanation">Context Sentences</p>
	<div id="context-sentences"></div>
</div>

<!--Box Section-->
<!--For: Radical, Kanji, Vocabulary-->
<div id=section-box>
	<div id=box-title></div>
	<div id=box-container></div>
</div>

<!--Found in Vocabulary Section-->
<!--For: Kanji-->
<div id=section-found-in-vocabulary>
	Found in Vocabulary<hr>
	<div id=found-in-vocabulary-container></div>
</div>

</div> <!-- id=card-back -->

<!--SCRIPT: Slice meanings and insert into the Meaning Section.-->
<script>
{
  let title = 'Meaning<hr>';
  if (`{{Card_Type}}` === 'Radical') title = 'Name<hr>';
  const div = document.getElementById('meaning-title');
  let element = document.createElement('p');
  element.innerHTML = title;
  div.appendChild(element);

  const meanings = `{{Meaning}}`;
  const array = meanings.split(',');
  const primary = array[0];
  const alternative = array.splice(1);
  const wordtype = `{{Word_Type}}`;

  const divMeanings = document.getElementById('meanings');
  element = document.createElement('p');
  element.innerHTML = `<b>PRIMARY </b>${primary.toString().toUpperCase()}`;
  divMeanings.appendChild(element);

  if (alternative.toString().length !== 0) {
    element = document.createElement('p');
    element.innerHTML = `<b>ALTERNATIVE </b>${alternative.toString().toUpperCase()}`;
    divMeanings.appendChild(element);
  }

  if (wordtype.toString().length !== 0) {
    element = document.createElement('p');
    element.innerHTML = `<b>WORD TYPE </b>${wordtype.toString().toUpperCase()}`;
    divMeanings.appendChild(element);
  }
}
</script>

<!--SCRIPT: Disable unused Reading divisions.-->
<script>
{
  if (`{{Card_Type}}` === 'Kana_Vocabulary') {
    document.getElementsByClassName('explanation')[1].style.display = 'none';
  }

  const disable_reading_div = (id, readings) => {
    const div = document.getElementById(id);
    if (readings === '') div.style.display = 'none';
    else div.style.display = '';
  };

  disable_reading_div('onyomi-readings', `{{Reading_Onyomi}}`);
  disable_reading_div('kunyomi-readings', `{{Reading_Kunyomi}}`);
  disable_reading_div('nanori-readings', `{{Reading_Nanori}}`);
}
</script>

<!--SCRIPT: Disable unused Hint divisions.-->
<script>
{
  const disable_hint_div = (id, readings) => {
    const div = document.getElementById(id);
    if (readings === '') div.style.display = 'none';
    else div.style.display = '';
  };

  disable_hint_div('meaning-hint', `{{Meaning_Hint}}`);
  disable_hint_div('reading-hint', `{{Reading_Hint}}`);
}
</script>

<!--SCRIPT: Slice and add Context Patterns.-->
<script>
{
  const combinations = `{{Context_Patterns}}`;
  const combinationsarray = combinations.split('|');

  for (let i = 1; i < 6; i += 2) {
    const div = document.getElementById('common-word-combinations');
    const element = document.createElement('p');
    const val1 = combinationsarray[0].split(';')[i];
    const val2 = combinationsarray[0].split(';')[i + 1];
    if (val1 === undefined) element.innerHTML = '<br>';
    else element.innerHTML = `<ja>${val1}</ja><br>${val2}`;
    element.setAttribute('id', i);
    div.appendChild(element);
  }

  for (let i = 0; i < combinationsarray.length; i++) {
    const div = document.getElementById('patterns-of-use');
    const element = document.createElement('div');
    const val = combinationsarray[i].split(';')[0];
    element.innerHTML = `<button class=notclicked id=button name='${i}' onclick='Click()'>${val}</button><br>`;
    div.appendChild(element);
  }

  const element = document.getElementsByName('0')[0];
  element.classList.add('notclicked');
  element.classList.add('clicked');

  window.Click = () => {
    const z = event.target.name;

    for (let i = 0; i < combinationsarray.length; i++) {
      const el = document.getElementsByName(i)[0];
      el.classList.remove('clicked');
      el.classList.add('notclicked');
    }

    const el = document.getElementsByName(event.target.name)[0];
    el.classList.add('clicked');
    el.classList.remove('notclicked');

    for (let i = 1; i < combinationsarray[z].length; i += 2) {
      const val1 = combinationsarray[z].split(';')[i];
      const val2 = combinationsarray[z].split(';')[i + 1];
      const targetEl = document.getElementById(i);
      if (val1 === undefined) targetEl.innerHTML = ' ';
      else targetEl.innerHTML = `<ja>${val1}</ja><br>${val2}`;
    }
  };

  if (combinations.length === 0) {
    document.getElementById('context-patterns').innerHTML = ' ';
  }
}
</script>

<!--SCRIPT: Slice and add context sentences.-->
<script>
{
  if (`{{Card_Type}}` === 'Vocabulary' || `{{Card_Type}}` === 'Kana_Vocabulary') {
    const sentences = `{{Context_Sentences}}`;
    const array = sentences.split('|');
    const div = document.getElementById('context-sentences');

    const appendContextSentence = (en, jp) => {
      if (jp !== '') {
        const element = document.createElement('p');
        element.innerHTML = `<p><ja>${jp}</ja><br>${en}</p>`;
        div.appendChild(element);
      }
    };

    appendContextSentence(array[0].toString(), array[1].toString());
    appendContextSentence(array[2].toString(), array[3].toString());
    appendContextSentence(array[4].toString(), array[5].toString());
  }
}
</script>

<!--SCRIPT: Disable divisions.-->
<script>
{
  const readingsection = document.getElementById('section-reading');
  const boxsection = document.getElementById('section-box');
  const contextsection = document.getElementById('section-context');
  const combinationsection = document.getElementById('section-radical-combination');
  const foundinvocabularysection = document.getElementById('section-found-in-vocabulary');

  if (`{{Card_Type}}` === 'Radical') {
    readingsection.style.display = 'none';
    contextsection.style.display = 'none';
    combinationsection.style.display = 'none';
    foundinvocabularysection.style.display = 'none';
  }
  if (`{{Card_Type}}` === 'Kanji') {
    contextsection.style.display = 'none';
  }
  if (`{{Card_Type}}` === 'Vocabulary') {
    combinationsection.style.display = 'none';
    foundinvocabularysection.style.display = 'none';
  }
  if (`{{Card_Type}}` === 'Kana_Vocabulary') {
    readingsection.style.display = 'none';
    combinationsection.style.display = 'none';
    foundinvocabularysection.style.display = 'none';
    boxsection.style.display = 'none';
  }
}
</script>

<!--SCRIPT: Populate Box Characters (Found in Kanji, Visually Similar Kanji and Kanji Composition).-->
<script>
{
  if (`{{Card_Type}}` === 'Radical') {
    const character = `{{Found_in_Characters}}`;
    const characterarray = character.split(', ');
    const meaning = `{{Found_in_Meaning}}`;
    const meaningarray = meaning.split(', ');
    const reading = `{{Found_in_Reading}}`;
    const readingarray = reading.split(', ');

    if (character.toString().length !== 0) {
      const div = document.getElementById('box-title');
      const element = document.createElement('div');
      element.innerHTML = 'Found In Kanji<hr>';
      div.appendChild(element);

      for (let i = 0; i < characterarray.length; i++) {
        const divContainer = document.getElementById('box-container');
        const elementContainer = document.createElement('div');
        elementContainer.innerHTML = `<div id=box-character>${characterarray[i]}<div id=box-meaning>${readingarray[i]}<br>${meaningarray[i]}</div></div>`;
        elementContainer.addEventListener('click', () => openWK('kanji', characterarray[i]));
        divContainer.appendChild(elementContainer);
      }
    }
  } else if (`{{Card_Type}}` === 'Kanji') {
    const character = `{{Similar_Characters}}`;
    const characterarray = character.split(', ');
    const meaning = `{{Similar_Meaning}}`;
    const meaningarray = meaning.split(', ');
    const reading = `{{Similar_Reading}}`;
    const readingarray = reading.split(', ');

    if (character.toString().length !== 0) {
      const div = document.getElementById('box-title');
      const element = document.createElement('div');
      element.innerHTML = 'Visually Similar Kanji<hr>';
      div.appendChild(element);

      for (let i = 0; i < characterarray.length; i++) {
        const divContainer = document.getElementById('box-container');
        const elementContainer = document.createElement('div');
        elementContainer.innerHTML = `<div id=box-character>${characterarray[i]}<div id=box-meaning>${readingarray[i]}<br>${meaningarray[i].toString().substring(0, 15)}</div></div>`;
        elementContainer.addEventListener('click', () => openWK('kanji', characterarray[i]));
        divContainer.appendChild(elementContainer);
      }
    }
  } else if (`{{Card_Type}}` === 'Vocabulary') {
    const character = `{{Components_Characters}}`;
    const characterarray = character.split(', ');
    const meaning = `{{Components_Meaning}}`;
    const meaningarray = meaning.split(', ');
    const reading = `{{Components_Reading}}`;
    const readingarray = reading.split(', ');

    if (character.toString().length !== 0) {
      const div = document.getElementById('box-title');
      const element = document.createElement('div');
      element.innerHTML = 'Kanji Composition<hr>';
      div.appendChild(element);

      for (let i = 0; i < characterarray.length; i++) {
        const divContainer = document.getElementById('box-container');
        const elementContainer = document.createElement('div');
        elementContainer.innerHTML = `<div id=box-character>${characterarray[i]}<div id=box-meaning>${readingarray[i]}<br>${meaningarray[i].toString().substring(0, 15)}</div></div>`;
        elementContainer.addEventListener('click', () => openWK('kanji', characterarray[i]));
        divContainer.appendChild(elementContainer);
      }
    }
  }
}
</script>

<!--SCRIPT: Add Radical Combination Characters.-->
<script>
{
  if (`{{Card_Type}}` === 'Kanji') {
    const character = `{{Components_Characters}}`;
    const characterarray = character.split(', ');
    const meaning = `{{Components_Meaning}}`;
    const meaningarray = meaning.split(', ');

    for (let i = 0; i < meaningarray.length; i++) {
      const div = document.getElementById('combination');
      const element = document.createElement('div');

      element.innerHTML = `<radical-combination>${characterarray[i]}</radical-combination>${meaningarray[i].toString().substring(0, 15)}`;
      element.addEventListener('click', () => openWK('radicals', meaningarray[i]));
      div.appendChild(element);

      if (i + 1 !== characterarray.length) {
        const elementPlus = document.createElement('p');
        elementPlus.innerHTML = '<div class=combination-plus><b>+</b></div>';
        div.appendChild(elementPlus);
      }
    }
  }
}
</script>

<!--SCRIPT: Add Found in Vocabulary Characters.-->
<script>
{
  if (`{{Card_Type}}` === 'Kanji') {
    const character = `{{Found_in_Characters}}`;
    const characterarray = character.split(', ');
    const meaning = `{{Found_in_Meaning}}`;
    const meaningarray = meaning.split(', ');
    const reading = `{{Found_in_Reading}}`;
    const readingarray = reading.split(', ');

    for (let i = 0; i < characterarray.length; i++) {
      const div = document.getElementById('found-in-vocabulary-container');
      const element = document.createElement('div');
      element.innerHTML = `<div id=found-in-vocabulary-box><div class=found-in-voc>${characterarray[i]}</div><div class=found-in-voc-reading>${readingarray[i]}<br>${meaningarray[i]}</div></div>`;
      element.addEventListener('click', () => openWK('vocabulary', characterarray[i]));
      div.appendChild(element);
    }

    if (character.toString().length === 0) {
      const foundinvocabularysection = document.getElementById('section-found-in-vocabulary');
      foundinvocabularysection.style.display = 'none';
    }
  }
}
</script>

<!--SCRIPT: Check the answer.-->
<script>
{
  const mainDiv = document.getElementById('main-input');
  if (mainDiv) {
    const mainInput = (sessionStorage.getItem('mainAnswer') || '').trim();
    const mainAnswer = mainInput.toLowerCase().replace(/'/g, '');

    const meaningWhitelist = `{{Meaning_Whitelist}}`.split(',')
      .map(item => item.trim().toLowerCase().replace(/'/g, ''))
      .filter(Boolean);
    const readingWhitelist = `{{Reading_Whitelist}}`.split(',')
      .map(item => item.trim().toLowerCase())
      .filter(Boolean);

    let correctAnswers = [];
    if (`{{Card}}` === 'Meaning') {
      correctAnswers = meaningWhitelist;
    } else if (`{{Card}}` === 'Reading') {
      correctAnswers = readingWhitelist;
    }

    const mainAnswerDiv = document.createElement('div');
    mainAnswerDiv.classList.add('answer-display');
    mainAnswerDiv.innerText = mainInput;
    if (`{{Card}}` === 'Reading') {
      mainAnswerDiv.style.fontFamily = 'Hiragino Kaku Gothic Pro W3';
    }

    const mainAnswers = mainAnswer.split(/,|、/).map(item => item.trim());
    let mainIncorrect = [];

    if (mainInput === '') {
      mainAnswerDiv.style.display = 'none';
    } else if (mainAnswers.some(ans => correctAnswers.includes(ans))) {
      mainAnswerDiv.classList.add('correct');
      mainIncorrect = mainAnswers.filter(ans => !correctAnswers.includes(ans));
    } else {
      mainAnswerDiv.classList.add('incorrect');
    }

    mainDiv.replaceWith(mainAnswerDiv);
    sessionStorage.setItem('mainAnswer', '');

    const optionalDiv = document.getElementById('optional-input');
    let optionalIncorrect = [];

    if (optionalDiv) {
      const optionalInput = (sessionStorage.getItem('optionalAnswer') || '').trim();
      const optionalAnswer = optionalInput.toLowerCase().replace(/'/g, '');

      const optionalAnswerDiv = document.createElement('div');
      optionalAnswerDiv.classList.add('answer-display');
      optionalAnswerDiv.innerText = optionalInput;

      const optionalAnswers = optionalAnswer.split(/,|、/).map(item => item.trim());

      if (optionalInput === '') {
        optionalAnswerDiv.style.display = 'none';
      } else if (optionalAnswers.some(ans => meaningWhitelist.includes(ans))) {
        optionalAnswerDiv.classList.add('correct');
        optionalIncorrect = optionalAnswers.filter(ans => !meaningWhitelist.includes(ans));
      } else {
        optionalAnswerDiv.classList.add('incorrect');
      }

      optionalDiv.replaceWith(optionalAnswerDiv);
      sessionStorage.setItem('optionalAnswer', '');
    }

    if (mainIncorrect.length > 0 || optionalIncorrect.length > 0) {
      let msg = '';
      if (mainIncorrect.length > 0) {
        msg += `Wrong {{Card}}: ${mainIncorrect.join(', ')}`;
      }
      if (mainIncorrect.length > 0 && optionalIncorrect.length > 0) {
        msg += '\n';
      }
      if (optionalIncorrect.length > 0) {
        msg += `Wrong Meaning: ${optionalIncorrect.join(', ')}`;
      }
      showToast(msg, true);
    }
  }
}
</script>

<!-- Generate tooltips -->
<script>
{
  const setTooltips = (tags, text) => {
    for (let i = 0; i < tags.length; i++) {
      tags[i].setAttribute('title', text);
    }
  };

  const kanji = document.getElementsByTagName('kanji');
  const radicals = document.getElementsByTagName('radical');
  const vocab = document.getElementsByTagName('vocabulary');
  const reading = document.getElementsByTagName('reading');

  setTooltips(kanji, 'Kanji');
  setTooltips(radicals, 'Radical');
  setTooltips(vocab, 'Vocabulary');
  setTooltips(reading, 'Reading');
}
</script>

<!-- Show Level/Link & Play Audio -->
<script>
{
  const level = document.getElementById('level');
  level.style.display = 'inline';

  const link = document.getElementById('wk-link');
  link.style.display = 'inline';

  const audio = document.querySelector('#reading-audios > :first-child'); //Female voice only or
  //const audio = document.querySelector("#reading-audios > :nthchild(2)"); //Male voice only
  if (audio) audio.click();
}
</script>
